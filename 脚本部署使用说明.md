# åŒ–å¦†å“é…æ–¹åŒ¹é…ç³»ç»Ÿ - è„šæœ¬éƒ¨ç½²ä½¿ç”¨è¯´æ˜

## ğŸ“‹ è„šæœ¬æ–‡ä»¶è¯´æ˜

### 1. æœåŠ¡å™¨ç»´æŠ¤.md
- **æè¿°**: å®Œæ•´çš„æœåŠ¡å™¨ç»´æŠ¤æŒ‡ä»¤å¤§å…¨
- **å†…å®¹**: åŒ…å«æ‰€æœ‰æ—¥å¸¸ç»´æŠ¤ã€æ•…éšœæ’æŸ¥ã€æ€§èƒ½ä¼˜åŒ–å‘½ä»¤
- **ç”¨é€”**: å‚è€ƒæ‰‹å†Œï¼Œç³»ç»Ÿç®¡ç†å‘˜å¿…å¤‡

### 2. auto_restart_services.sh  
- **æè¿°**: åŠŸèƒ½é½å…¨çš„è‡ªåŠ¨é‡å¯è„šæœ¬
- **åŠŸèƒ½**: æ™ºèƒ½é‡å¯ã€å¥åº·æ£€æŸ¥ã€é…ç½®å¤‡ä»½ã€é”™è¯¯å¤„ç†
- **ç”¨é€”**: ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨

### 3. quick_restart.sh
- **æè¿°**: ç®€åŒ–ç‰ˆå¿«é€Ÿé‡å¯è„šæœ¬  
- **åŠŸèƒ½**: å¿«é€Ÿé‡å¯æ‰€æœ‰æœåŠ¡å¹¶æ£€æŸ¥çŠ¶æ€
- **ç”¨é€”**: æ—¥å¸¸å¿«é€Ÿé‡å¯

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ è„šæœ¬åˆ°æœåŠ¡å™¨

```bash
# ä»æœ¬åœ°ä¸Šä¼ è„šæœ¬æ–‡ä»¶åˆ°æœåŠ¡å™¨
scp auto_restart_services.sh root@your_server_ip:/opt/cosmetic_formula_system/
scp quick_restart.sh root@your_server_ip:/opt/cosmetic_formula_system/
scp æœåŠ¡å™¨ç»´æŠ¤.md root@your_server_ip:/opt/cosmetic_formula_system/
```

### ç¬¬äºŒæ­¥ï¼šè®¾ç½®è„šæœ¬æƒé™

```bash
# ç™»å½•æœåŠ¡å™¨
ssh root@your_server_ip

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/cosmetic_formula_system

# è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
chmod +x auto_restart_services.sh
chmod +x quick_restart.sh

# è®¾ç½®æ‰€æœ‰è€…
chown root:root auto_restart_services.sh quick_restart.sh
```

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºè½¯é“¾æ¥ï¼ˆå¯é€‰ï¼‰

```bash
# åˆ›å»ºå…¨å±€å‘½ä»¤è½¯é“¾æ¥ï¼Œæ–¹ä¾¿åœ¨ä»»æ„ç›®å½•ä½¿ç”¨
ln -sf /opt/cosmetic_formula_system/auto_restart_services.sh /usr/local/bin/cosmetic-restart
ln -sf /opt/cosmetic_formula_system/quick_restart.sh /usr/local/bin/cosmetic-quick

# ç°åœ¨å¯ä»¥åœ¨ä»»æ„ç›®å½•ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
# cosmetic-restart
# cosmetic-quick
```

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### auto_restart_services.sh ä½¿ç”¨æ–¹æ³•

#### åŸºæœ¬ç”¨æ³•

```bash
# å®Œå…¨é‡å¯æ‰€æœ‰æœåŠ¡ï¼ˆé»˜è®¤ï¼‰
sudo ./auto_restart_services.sh

# æˆ–ä½¿ç”¨è½¯é“¾æ¥
sudo cosmetic-restart
```

#### ä¸åŒé‡å¯æ¨¡å¼

```bash
# åªé‡å¯åº”ç”¨æœåŠ¡
sudo ./auto_restart_services.sh app

# åªé‡å¯WebæœåŠ¡  
sudo ./auto_restart_services.sh web

# åªé‡å¯æ•°æ®åº“
sudo ./auto_restart_services.sh db

# ä¼˜é›…é‡å¯ï¼ˆç­‰å¾…è¿æ¥ç»“æŸï¼‰
sudo ./auto_restart_services.sh graceful
```

#### é«˜çº§é€‰é¡¹

```bash
# é‡å¯å‰å¤‡ä»½é…ç½®æ–‡ä»¶
sudo ./auto_restart_services.sh --backup

# å¼ºåˆ¶é‡å¯ï¼ˆè·³è¿‡å¥åº·æ£€æŸ¥ï¼‰
sudo ./auto_restart_services.sh --force

# è¯¦ç»†è¾“å‡ºæ¨¡å¼
sudo ./auto_restart_services.sh --verbose

# æµ‹è¯•æ¨¡å¼ï¼ˆåªæ˜¾ç¤ºå°†è¦æ‰§è¡Œçš„æ“ä½œï¼‰
sudo ./auto_restart_services.sh --test

# ä»…æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo ./auto_restart_services.sh --check

# ç»„åˆä½¿ç”¨
sudo ./auto_restart_services.sh full --backup --verbose
```

#### æŸ¥çœ‹å¸®åŠ©

```bash
sudo ./auto_restart_services.sh --help
```

### quick_restart.sh ä½¿ç”¨æ–¹æ³•

```bash
# å¿«é€Ÿé‡å¯æ‰€æœ‰æœåŠ¡
sudo ./quick_restart.sh

# æˆ–ä½¿ç”¨è½¯é“¾æ¥
sudo cosmetic-quick
```

---

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### æ—¥å¸¸ç»´æŠ¤
- **æ¯æ—¥é‡å¯**: `sudo cosmetic-quick`
- **å®Œæ•´é‡å¯**: `sudo cosmetic-restart full --backup`
- **çŠ¶æ€æ£€æŸ¥**: `sudo cosmetic-restart --check`

### æ•…éšœå¤„ç†
- **æœåŠ¡å¼‚å¸¸**: `sudo cosmetic-restart --force`
- **ç«¯å£å ç”¨**: `sudo cosmetic-restart app --force`
- **é…ç½®æ›´æ–°å**: `sudo cosmetic-restart --backup`

### ç³»ç»Ÿå‡çº§
- **å‡çº§å‰**: `sudo cosmetic-restart --check --backup`
- **å‡çº§å**: `sudo cosmetic-restart full --verbose`

---

## ğŸ“ è‡ªåŠ¨åŒ–é…ç½®

### 1. å®šæ—¶é‡å¯ï¼ˆå¯é€‰ï¼‰

```bash
# ç¼–è¾‘crontab
sudo crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼šæ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨é‡å¯åº”ç”¨æœåŠ¡
0 3 * * * /opt/cosmetic_formula_system/auto_restart_services.sh app --backup > /var/log/cosmetic_auto_restart.log 2>&1

# æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹å®Œå…¨é‡å¯
0 2 * * 0 /opt/cosmetic_formula_system/auto_restart_services.sh full --backup > /var/log/cosmetic_weekly_restart.log 2>&1
```

### 2. ç›‘æ§è„šæœ¬ï¼ˆè‡ªåŠ¨æ•…éšœæ¢å¤ï¼‰

```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
sudo nano /opt/cosmetic_formula_system/monitor.sh
```

```bash
#!/bin/bash
# æœåŠ¡ç›‘æ§å’Œè‡ªåŠ¨æ¢å¤è„šæœ¬

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
if ! systemctl is-active --quiet cosmetic-formula; then
    echo "$(date): æ£€æµ‹åˆ°åº”ç”¨æœåŠ¡å¼‚å¸¸ï¼Œæ‰§è¡Œè‡ªåŠ¨é‡å¯" >> /var/log/cosmetic_monitor.log
    /opt/cosmetic_formula_system/auto_restart_services.sh app --force >> /var/log/cosmetic_monitor.log 2>&1
fi

# æ£€æŸ¥HTTPå“åº”
if ! timeout 10 curl -s http://localhost > /dev/null 2>&1; then
    echo "$(date): æ£€æµ‹åˆ°HTTPæœåŠ¡å¼‚å¸¸ï¼Œæ‰§è¡Œè‡ªåŠ¨é‡å¯" >> /var/log/cosmetic_monitor.log
    /opt/cosmetic_formula_system/auto_restart_services.sh web --force >> /var/log/cosmetic_monitor.log 2>&1
fi
```

```bash
# è®¾ç½®æ‰§è¡Œæƒé™
sudo chmod +x /opt/cosmetic_formula_system/monitor.sh

# æ·»åŠ åˆ°crontabï¼Œæ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
# */5 * * * * /opt/cosmetic_formula_system/monitor.sh
```

---

## ğŸ” æ—¥å¿—å’Œæ•…éšœæ’æŸ¥

### è„šæœ¬æ—¥å¿—ä½ç½®

```bash
# è‡ªåŠ¨é‡å¯è„šæœ¬æ—¥å¿—
tail -f /var/log/cosmetic_formula_restart.log

# ç›‘æ§è„šæœ¬æ—¥å¿—
tail -f /var/log/cosmetic_monitor.log

# ç³»ç»ŸæœåŠ¡æ—¥å¿—
sudo journalctl -u cosmetic-formula -f
```

### å¸¸è§é—®é¢˜å¤„ç†

#### 1. è„šæœ¬æƒé™é”™è¯¯
```bash
# é‡æ–°è®¾ç½®æƒé™
sudo chmod +x /opt/cosmetic_formula_system/*.sh
sudo chown root:root /opt/cosmetic_formula_system/*.sh
```

#### 2. æœåŠ¡é‡å¯å¤±è´¥
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
sudo ./auto_restart_services.sh --check --verbose

# æ‰‹åŠ¨è¯Šæ–­
sudo journalctl -u cosmetic-formula -n 100
```

#### 3. ç«¯å£è¢«å ç”¨
```bash
# å¼ºåˆ¶é‡å¯æ¸…ç†ç«¯å£
sudo ./auto_restart_services.sh app --force

# æ‰‹åŠ¨æ¸…ç†ç«¯å£
sudo fuser -k 8000/tcp
```

---

## ğŸ›¡ï¸ å®‰å…¨å»ºè®®

### 1. æ–‡ä»¶æƒé™
- è„šæœ¬æ–‡ä»¶åº”è¯¥åªæœ‰rootç”¨æˆ·å¯å†™
- æ—¥å¿—æ–‡ä»¶åº”è¯¥è®¾ç½®é€‚å½“çš„è¯»å–æƒé™

### 2. å¤‡ä»½ç­–ç•¥
- é‡è¦æ“ä½œå‰å§‹ç»ˆä½¿ç”¨ `--backup` é€‰é¡¹
- å®šæœŸæ£€æŸ¥å¤‡ä»½æ–‡ä»¶çš„å®Œæ•´æ€§

### 3. ç›‘æ§å‘Šè­¦
- è®¾ç½®å…³é”®æœåŠ¡çš„ç›‘æ§å‘Šè­¦
- é…ç½®æ—¥å¿—è½®è½¬é¿å…æ—¥å¿—æ–‡ä»¶è¿‡å¤§

```bash
# åˆ›å»ºæ—¥å¿—è½®è½¬é…ç½®
sudo nano /etc/logrotate.d/cosmetic-formula
```

```
/var/log/cosmetic_formula_restart.log
/var/log/cosmetic_monitor.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
}
```

---

## ğŸ“ è”ç³»æ”¯æŒ

å¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**: `sudo ./auto_restart_services.sh --check --verbose`
2. **è¿è¡Œè¯Šæ–­**: å‚è€ƒã€ŠæœåŠ¡å™¨ç»´æŠ¤.mdã€‹ä¸­çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†
3. **å¤‡ä»½ç³»ç»Ÿ**: ç¡®ä¿é‡è¦æ•°æ®å·²å¤‡ä»½
4. **è”ç³»ç®¡ç†å‘˜**: æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œç³»ç»ŸçŠ¶æ€

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: $(date +"%Y-%m-%d")  
**å…¼å®¹ç³»ç»Ÿ**: Ubuntu 24.04 LTS  
**è„šæœ¬ç»´æŠ¤**: ç³»ç»Ÿç®¡ç†å‘˜
