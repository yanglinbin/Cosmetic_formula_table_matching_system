# 化妆品配方匹配系统 - 脚本部署使用说明

## 📋 脚本文件说明

### 1. 服务器维护.md
- **描述**: 完整的服务器维护指令大全
- **内容**: 包含所有日常维护、故障排查、性能优化命令
- **用途**: 参考手册，系统管理员必备

### 2. auto_restart_services.sh  
- **描述**: 功能齐全的自动重启脚本
- **功能**: 智能重启、健康检查、配置备份、错误处理
- **用途**: 生产环境推荐使用

### 3. quick_restart.sh
- **描述**: 简化版快速重启脚本  
- **功能**: 快速重启所有服务并检查状态
- **用途**: 日常快速重启

---

## 🚀 部署步骤

### 第一步：上传脚本到服务器

```bash
# 从本地上传脚本文件到服务器
scp auto_restart_services.sh root@your_server_ip:/opt/cosmetic_formula_system/
scp quick_restart.sh root@your_server_ip:/opt/cosmetic_formula_system/
scp 服务器维护.md root@your_server_ip:/opt/cosmetic_formula_system/
```

### 第二步：设置脚本权限

```bash
# 登录服务器
ssh root@your_server_ip

# 进入项目目录
cd /opt/cosmetic_formula_system

# 设置脚本执行权限
chmod +x auto_restart_services.sh
chmod +x quick_restart.sh

# 设置所有者
chown root:root auto_restart_services.sh quick_restart.sh
```

### 第三步：创建软链接（可选）

```bash
# 创建全局命令软链接，方便在任意目录使用
ln -sf /opt/cosmetic_formula_system/auto_restart_services.sh /usr/local/bin/cosmetic-restart
ln -sf /opt/cosmetic_formula_system/quick_restart.sh /usr/local/bin/cosmetic-quick

# 现在可以在任意目录使用以下命令：
# cosmetic-restart
# cosmetic-quick
```

---

## 📖 使用指南

### auto_restart_services.sh 使用方法

#### 基本用法

```bash
# 完全重启所有服务（默认）
sudo ./auto_restart_services.sh

# 或使用软链接
sudo cosmetic-restart
```

#### 不同重启模式

```bash
# 只重启应用服务
sudo ./auto_restart_services.sh app

# 只重启Web服务  
sudo ./auto_restart_services.sh web

# 只重启数据库
sudo ./auto_restart_services.sh db

# 优雅重启（等待连接结束）
sudo ./auto_restart_services.sh graceful
```

#### 高级选项

```bash
# 重启前备份配置文件
sudo ./auto_restart_services.sh --backup

# 强制重启（跳过健康检查）
sudo ./auto_restart_services.sh --force

# 详细输出模式
sudo ./auto_restart_services.sh --verbose

# 测试模式（只显示将要执行的操作）
sudo ./auto_restart_services.sh --test

# 仅检查服务状态
sudo ./auto_restart_services.sh --check

# 组合使用
sudo ./auto_restart_services.sh full --backup --verbose
```

#### 查看帮助

```bash
sudo ./auto_restart_services.sh --help
```

### quick_restart.sh 使用方法

```bash
# 快速重启所有服务
sudo ./quick_restart.sh

# 或使用软链接
sudo cosmetic-quick
```

---

## 📊 使用场景

### 日常维护
- **每日重启**: `sudo cosmetic-quick`
- **完整重启**: `sudo cosmetic-restart full --backup`
- **状态检查**: `sudo cosmetic-restart --check`

### 故障处理
- **服务异常**: `sudo cosmetic-restart --force`
- **端口占用**: `sudo cosmetic-restart app --force`
- **配置更新后**: `sudo cosmetic-restart --backup`

### 系统升级
- **升级前**: `sudo cosmetic-restart --check --backup`
- **升级后**: `sudo cosmetic-restart full --verbose`

---

## 📝 自动化配置

### 1. 定时重启（可选）

```bash
# 编辑crontab
sudo crontab -e

# 添加以下行：每天凌晨3点自动重启应用服务
0 3 * * * /opt/cosmetic_formula_system/auto_restart_services.sh app --backup > /var/log/cosmetic_auto_restart.log 2>&1

# 每周日凌晨2点完全重启
0 2 * * 0 /opt/cosmetic_formula_system/auto_restart_services.sh full --backup > /var/log/cosmetic_weekly_restart.log 2>&1
```

### 2. 监控脚本（自动故障恢复）

```bash
# 创建监控脚本
sudo nano /opt/cosmetic_formula_system/monitor.sh
```

```bash
#!/bin/bash
# 服务监控和自动恢复脚本

# 检查服务状态
if ! systemctl is-active --quiet cosmetic-formula; then
    echo "$(date): 检测到应用服务异常，执行自动重启" >> /var/log/cosmetic_monitor.log
    /opt/cosmetic_formula_system/auto_restart_services.sh app --force >> /var/log/cosmetic_monitor.log 2>&1
fi

# 检查HTTP响应
if ! timeout 10 curl -s http://localhost > /dev/null 2>&1; then
    echo "$(date): 检测到HTTP服务异常，执行自动重启" >> /var/log/cosmetic_monitor.log
    /opt/cosmetic_formula_system/auto_restart_services.sh web --force >> /var/log/cosmetic_monitor.log 2>&1
fi
```

```bash
# 设置执行权限
sudo chmod +x /opt/cosmetic_formula_system/monitor.sh

# 添加到crontab，每5分钟检查一次
# */5 * * * * /opt/cosmetic_formula_system/monitor.sh
```

---

## 🔍 日志和故障排查

### 脚本日志位置

```bash
# 自动重启脚本日志
tail -f /var/log/cosmetic_formula_restart.log

# 监控脚本日志
tail -f /var/log/cosmetic_monitor.log

# 系统服务日志
sudo journalctl -u cosmetic-formula -f
```

### 常见问题处理

#### 1. 脚本权限错误
```bash
# 重新设置权限
sudo chmod +x /opt/cosmetic_formula_system/*.sh
sudo chown root:root /opt/cosmetic_formula_system/*.sh
```

#### 2. 服务重启失败
```bash
# 查看详细错误日志
sudo ./auto_restart_services.sh --check --verbose

# 手动诊断
sudo journalctl -u cosmetic-formula -n 100
```

#### 3. 端口被占用
```bash
# 强制重启清理端口
sudo ./auto_restart_services.sh app --force

# 手动清理端口
sudo fuser -k 8000/tcp
```

---

## 🛡️ 安全建议

### 1. 文件权限
- 脚本文件应该只有root用户可写
- 日志文件应该设置适当的读取权限

### 2. 备份策略
- 重要操作前始终使用 `--backup` 选项
- 定期检查备份文件的完整性

### 3. 监控告警
- 设置关键服务的监控告警
- 配置日志轮转避免日志文件过大

```bash
# 创建日志轮转配置
sudo nano /etc/logrotate.d/cosmetic-formula
```

```
/var/log/cosmetic_formula_restart.log
/var/log/cosmetic_monitor.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
}
```

---

## 📞 联系支持

如果在使用过程中遇到问题：

1. **查看日志**: `sudo ./auto_restart_services.sh --check --verbose`
2. **运行诊断**: 参考《服务器维护.md》中的故障排查部分
3. **备份系统**: 确保重要数据已备份
4. **联系管理员**: 提供详细的错误日志和系统状态

---

**文档版本**: v1.0  
**最后更新**: $(date +"%Y-%m-%d")  
**兼容系统**: Ubuntu 24.04 LTS  
**脚本维护**: 系统管理员
