# åŒ–å¦†å“é…æ–¹åŒ¹é…ç³»ç»Ÿ - æœåŠ¡å™¨ç»´æŠ¤æŒ‡ä»¤å¤§å…¨

## ğŸ“‹ ç³»ç»Ÿæ¦‚è§ˆ

- **ç³»ç»Ÿåç§°**: åŒ–å¦†å“é…æ–¹è¡¨åŒ¹é…ç³»ç»Ÿ
- **éƒ¨ç½²è·¯å¾„**: `/opt/cosmetic_formula_system`
- **æœåŠ¡åç§°**: `cosmetic-formula`
- **ç«¯å£**: 8000 (å†…éƒ¨), 80 (å¤–éƒ¨)
- **æ•°æ®åº“**: MySQL (ç«¯å£3306)
- **WebæœåŠ¡å™¨**: Nginx (ç«¯å£80)

---

## ğŸš€ æ ¸å¿ƒæœåŠ¡ç®¡ç†

### 1. æœåŠ¡çŠ¶æ€æ£€æŸ¥

```bash
# æ£€æŸ¥ä¸»è¦æœåŠ¡çŠ¶æ€
sudo systemctl status cosmetic-formula    # Pythonåº”ç”¨æœåŠ¡
sudo systemctl status nginx               # WebæœåŠ¡å™¨
sudo systemctl status mysql              # æ•°æ®åº“æœåŠ¡

# ä¸€é”®æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
sudo systemctl status cosmetic-formula nginx mysql --no-pager
```

### 2. æœåŠ¡å¯åŠ¨/åœæ­¢/é‡å¯

```bash
# === Pythonåº”ç”¨æœåŠ¡ ===
sudo systemctl start cosmetic-formula     # å¯åŠ¨åº”ç”¨æœåŠ¡
sudo systemctl stop cosmetic-formula      # åœæ­¢åº”ç”¨æœåŠ¡
sudo systemctl restart cosmetic-formula   # é‡å¯åº”ç”¨æœåŠ¡
sudo systemctl reload cosmetic-formula    # é‡æ–°åŠ è½½é…ç½®

# === Nginx WebæœåŠ¡å™¨ ===
sudo systemctl start nginx                # å¯åŠ¨Nginx
sudo systemctl stop nginx                 # åœæ­¢Nginx
sudo systemctl restart nginx              # é‡å¯Nginx
sudo systemctl reload nginx               # é‡æ–°åŠ è½½Nginxé…ç½®
sudo nginx -s reload                      # å¿«é€Ÿé‡è½½Nginxé…ç½®

# === MySQLæ•°æ®åº“ ===
sudo systemctl start mysql                # å¯åŠ¨MySQL
sudo systemctl stop mysql                 # åœæ­¢MySQL
sudo systemctl restart mysql              # é‡å¯MySQL

# === ä¸€é”®é‡å¯æ‰€æœ‰æœåŠ¡ ===
sudo systemctl restart mysql && \
sudo systemctl restart cosmetic-formula && \
sudo systemctl restart nginx && \
echo "âœ… æ‰€æœ‰æœåŠ¡é‡å¯å®Œæˆ"
```

### 3. å¼€æœºè‡ªå¯ç®¡ç†

```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦è®¾ç½®ä¸ºå¼€æœºè‡ªå¯
sudo systemctl is-enabled cosmetic-formula nginx mysql

# å¯ç”¨å¼€æœºè‡ªå¯
sudo systemctl enable cosmetic-formula    # è®¾ç½®åº”ç”¨æœåŠ¡å¼€æœºè‡ªå¯
sudo systemctl enable nginx              # è®¾ç½®Nginxå¼€æœºè‡ªå¯
sudo systemctl enable mysql              # è®¾ç½®MySQLå¼€æœºè‡ªå¯

# ç¦ç”¨å¼€æœºè‡ªå¯
sudo systemctl disable cosmetic-formula   # ç¦ç”¨åº”ç”¨æœåŠ¡å¼€æœºè‡ªå¯
sudo systemctl disable nginx             # ç¦ç”¨Nginxå¼€æœºè‡ªå¯
sudo systemctl disable mysql             # ç¦ç”¨MySQLå¼€æœºè‡ªå¯
```

---

## ğŸ“Š ç›‘æ§å’Œè¯Šæ–­

### 1. ç«¯å£å’Œè¿æ¥ç›‘æ§

```bash
# æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€
sudo netstat -tlnp | grep -E ':80|:8000|:3306'    # æ£€æŸ¥å…³é”®ç«¯å£
sudo ss -tlnp | grep -E ':80|:8000|:3306'         # ç°ä»£ç‰ˆæœ¬çš„ç«¯å£æ£€æŸ¥

# æ£€æŸ¥å…·ä½“ç«¯å£å ç”¨
sudo lsof -i:8000    # æ£€æŸ¥8000ç«¯å£ï¼ˆPythonåº”ç”¨ï¼‰
sudo lsof -i:80      # æ£€æŸ¥80ç«¯å£ï¼ˆNginxï¼‰
sudo lsof -i:3306    # æ£€æŸ¥3306ç«¯å£ï¼ˆMySQLï¼‰

# æ£€æŸ¥ç½‘ç»œè¿æ¥æ•°
sudo netstat -ant | grep :80 | wc -l              # ç»Ÿè®¡80ç«¯å£è¿æ¥æ•°
sudo netstat -ant | grep :8000 | wc -l            # ç»Ÿè®¡8000ç«¯å£è¿æ¥æ•°
```

### 2. è¿›ç¨‹ç›‘æ§

```bash
# æŸ¥çœ‹ç›¸å…³è¿›ç¨‹
ps aux | grep -E 'python|nginx|mysql'             # æŸ¥çœ‹ä¸»è¦è¿›ç¨‹
ps aux | grep cosmetic                             # æŸ¥çœ‹åº”ç”¨ç›¸å…³è¿›ç¨‹

# æŸ¥çœ‹è¿›ç¨‹æ ‘
pstree -p | grep -E 'python|nginx|mysql'

# æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ
top -p $(pgrep -d',' -f 'python.*main.py')        # ç›‘æ§Pythonåº”ç”¨èµ„æºä½¿ç”¨
htop                                               # å®æ—¶ç³»ç»Ÿç›‘æ§ï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
```

### 3. ç³»ç»Ÿèµ„æºç›‘æ§

```bash
# å†…å­˜ä½¿ç”¨æƒ…å†µ
free -h                                            # æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ
free -h -s 5                                       # æ¯5ç§’æ›´æ–°ä¸€æ¬¡å†…å­˜ä½¿ç”¨æƒ…å†µ

# ç£ç›˜ä½¿ç”¨æƒ…å†µ
df -h                                              # æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ
du -sh /opt/cosmetic_formula_system                # æŸ¥çœ‹é¡¹ç›®ç›®å½•å¤§å°
du -sh /var/log/                                   # æŸ¥çœ‹æ—¥å¿—ç›®å½•å¤§å°

# CPUä½¿ç”¨æƒ…å†µ
uptime                                             # ç³»ç»Ÿè´Ÿè½½
iostat -x 1                                        # I/Oç»Ÿè®¡ï¼ˆå¦‚æœå·²å®‰è£…sysstatï¼‰
```

---

## ğŸ“ æ—¥å¿—ç®¡ç†

### 1. åº”ç”¨æ—¥å¿—æŸ¥çœ‹

```bash
# === å®æ—¶æ—¥å¿—ç›‘æ§ ===
sudo journalctl -u cosmetic-formula -f            # å®æ—¶æŸ¥çœ‹åº”ç”¨æ—¥å¿—
sudo journalctl -u nginx -f                       # å®æ—¶æŸ¥çœ‹Nginxæ—¥å¿—
sudo journalctl -u mysql -f                       # å®æ—¶æŸ¥çœ‹MySQLæ—¥å¿—

# === å†å²æ—¥å¿—æŸ¥çœ‹ ===
sudo journalctl -u cosmetic-formula -n 50         # æŸ¥çœ‹æœ€è¿‘50è¡Œåº”ç”¨æ—¥å¿—
sudo journalctl -u cosmetic-formula --since "1 hour ago"  # æŸ¥çœ‹æœ€è¿‘1å°æ—¶çš„æ—¥å¿—
sudo journalctl -u cosmetic-formula --since "2023-09-08 00:00:00"  # æŸ¥çœ‹æŒ‡å®šæ—¶é—´åçš„æ—¥å¿—

# === é”™è¯¯æ—¥å¿—ç­›é€‰ ===
sudo journalctl -u cosmetic-formula | grep -i error       # ç­›é€‰é”™è¯¯ä¿¡æ¯
sudo journalctl -u cosmetic-formula | grep -i "500"       # ç­›é€‰HTTP 500é”™è¯¯
sudo journalctl -u cosmetic-formula | grep -i "exception" # ç­›é€‰å¼‚å¸¸ä¿¡æ¯
```

### 2. Nginxæ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹Nginxè®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/access.log             # å®æ—¶æŸ¥çœ‹è®¿é—®æ—¥å¿—
sudo tail -n 100 /var/log/nginx/access.log         # æŸ¥çœ‹æœ€è¿‘100è¡Œè®¿é—®æ—¥å¿—

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log              # å®æ—¶æŸ¥çœ‹é”™è¯¯æ—¥å¿—
sudo tail -n 50 /var/log/nginx/error.log           # æŸ¥çœ‹æœ€è¿‘50è¡Œé”™è¯¯æ—¥å¿—

# ç»Ÿè®¡è®¿é—®æƒ…å†µ
sudo cat /var/log/nginx/access.log | grep -c "200"        # ç»Ÿè®¡æˆåŠŸè¯·æ±‚æ•°
sudo cat /var/log/nginx/access.log | grep -c "500"        # ç»Ÿè®¡æœåŠ¡å™¨é”™è¯¯æ•°
sudo cat /var/log/nginx/access.log | awk '{print $1}' | sort | uniq -c | sort -nr | head -10  # ç»Ÿè®¡è®¿é—®IP
```

### 3. æ—¥å¿—æ¸…ç†å’Œç»´æŠ¤

```bash
# æ¸…ç†journaldæ—¥å¿—ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰
sudo journalctl --vacuum-time=7d

# æ¸…ç†journaldæ—¥å¿—ï¼ˆé™åˆ¶å¤§å°ä¸º100MBï¼‰
sudo journalctl --vacuum-size=100M

# æ¸…ç†Nginxæ—¥å¿—ï¼ˆå¤‡ä»½åæ¸…ç†ï¼‰
sudo cp /var/log/nginx/access.log /var/log/nginx/access.log.backup.$(date +%Y%m%d)
sudo echo "" > /var/log/nginx/access.log
sudo cp /var/log/nginx/error.log /var/log/nginx/error.log.backup.$(date +%Y%m%d)
sudo echo "" > /var/log/nginx/error.log

# é‡å¯rsyslogæœåŠ¡ï¼ˆé‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼‰
sudo systemctl restart rsyslog
```

---

## ğŸ”§ é…ç½®æ–‡ä»¶ç®¡ç†

### 1. åº”ç”¨é…ç½®æ–‡ä»¶

```bash
# æŸ¥çœ‹åº”ç”¨é…ç½®
cat /opt/cosmetic_formula_system/system_config.ini         # ç³»ç»Ÿé…ç½®
cat /opt/cosmetic_formula_system/mysql_config.ini          # æ•°æ®åº“é…ç½®

# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /opt/cosmetic_formula_system/system_config.ini   # ç¼–è¾‘ç³»ç»Ÿé…ç½®
sudo nano /opt/cosmetic_formula_system/mysql_config.ini    # ç¼–è¾‘æ•°æ®åº“é…ç½®

# å¤‡ä»½é…ç½®æ–‡ä»¶
sudo cp /opt/cosmetic_formula_system/system_config.ini \
    /opt/cosmetic_formula_system/system_config.ini.backup.$(date +%Y%m%d_%H%M%S)
sudo cp /opt/cosmetic_formula_system/mysql_config.ini \
    /opt/cosmetic_formula_system/mysql_config.ini.backup.$(date +%Y%m%d_%H%M%S)
```

### 2. Nginxé…ç½®ç®¡ç†

```bash
# æŸ¥çœ‹Nginxé…ç½®
sudo cat /etc/nginx/sites-available/cosmetic-formula       # æŸ¥çœ‹ç«™ç‚¹é…ç½®
sudo nginx -t                                              # æµ‹è¯•Nginxé…ç½®è¯­æ³•

# ç¼–è¾‘Nginxé…ç½®
sudo nano /etc/nginx/sites-available/cosmetic-formula      # ç¼–è¾‘ç«™ç‚¹é…ç½®

# é‡æ–°åŠ è½½Nginxé…ç½®
sudo nginx -s reload                                        # é‡è½½é…ç½®ï¼ˆæ¨èï¼‰
sudo systemctl reload nginx                                # é‡è½½é…ç½®
```

### 3. ç³»ç»ŸæœåŠ¡é…ç½®

```bash
# æŸ¥çœ‹åº”ç”¨æœåŠ¡é…ç½®
sudo cat /etc/systemd/system/cosmetic-formula.service      # æŸ¥çœ‹æœåŠ¡é…ç½®

# ç¼–è¾‘æœåŠ¡é…ç½®
sudo nano /etc/systemd/system/cosmetic-formula.service     # ç¼–è¾‘æœåŠ¡é…ç½®

# é‡æ–°åŠ è½½ç³»ç»ŸæœåŠ¡é…ç½®
sudo systemctl daemon-reload                               # é‡è½½systemdé…ç½®
sudo systemctl restart cosmetic-formula                    # é‡å¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ
```

---

## ğŸ’¾ æ•°æ®åº“ç»´æŠ¤

### 1. MySQLè¿æ¥å’ŒçŠ¶æ€æ£€æŸ¥

```bash
# è¿æ¥MySQLæ•°æ®åº“
mysql -u root -p                                           # ç®¡ç†å‘˜è¿æ¥
mysql -u cosmetic_user -p cosmetic_formula_db             # åº”ç”¨ç”¨æˆ·è¿æ¥

# æ£€æŸ¥MySQLçŠ¶æ€
sudo systemctl status mysql                                # æœåŠ¡çŠ¶æ€
mysqladmin -u root -p status                              # MySQLæœåŠ¡çŠ¶æ€
mysqladmin -u root -p processlist                         # å½“å‰è¿æ¥åˆ—è¡¨
```

### 2. æ•°æ®åº“å¤‡ä»½

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
sudo mkdir -p /opt/backups/cosmetic_formula_db

# å®Œæ•´æ•°æ®åº“å¤‡ä»½
sudo mysqldump -u root -p cosmetic_formula_db > /opt/backups/cosmetic_formula_db/backup_$(date +%Y%m%d_%H%M%S).sql

# å¤‡ä»½æŒ‡å®šè¡¨
sudo mysqldump -u root -p cosmetic_formula_db formulas formula_ingredients > /opt/backups/cosmetic_formula_db/formulas_backup_$(date +%Y%m%d_%H%M%S).sql

# è‡ªåŠ¨å¤‡ä»½è„šæœ¬ï¼ˆæ·»åŠ åˆ°crontabï¼‰
# 0 2 * * * /usr/bin/mysqldump -u root -pYOUR_PASSWORD cosmetic_formula_db > /opt/backups/cosmetic_formula_db/auto_backup_$(date +\%Y\%m\%d).sql
```

### 3. æ•°æ®åº“æ¢å¤

```bash
# æ¢å¤å®Œæ•´æ•°æ®åº“
mysql -u root -p cosmetic_formula_db < /opt/backups/cosmetic_formula_db/backup_20230908_120000.sql

# æ¢å¤æŒ‡å®šè¡¨
mysql -u root -p cosmetic_formula_db < /opt/backups/cosmetic_formula_db/formulas_backup_20230908_120000.sql
```

### 4. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

```bash
# æ£€æŸ¥æ•°æ®åº“å¤§å°
mysql -u root -p -e "SELECT table_schema 'Database', ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) 'Size (MB)' FROM information_schema.tables WHERE table_schema='cosmetic_formula_db' GROUP BY table_schema;"

# ä¼˜åŒ–è¡¨
mysql -u root -p cosmetic_formula_db -e "OPTIMIZE TABLE formulas, formula_ingredients;"

# æ£€æŸ¥è¡¨çŠ¶æ€
mysql -u root -p cosmetic_formula_db -e "SHOW TABLE STATUS;"
```

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### 1. åº”ç”¨æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯
sudo systemctl status cosmetic-formula -l                  # æŸ¥çœ‹è¯¦ç»†çŠ¶æ€ä¿¡æ¯
sudo journalctl -u cosmetic-formula -n 100                # æŸ¥çœ‹æœ€è¿‘100è¡Œæ—¥å¿—

# æ£€æŸ¥ç«¯å£å ç”¨
sudo lsof -i:8000                                          # æ£€æŸ¥8000ç«¯å£å ç”¨
sudo fuser -k 8000/tcp                                     # å¼ºåˆ¶ç»“æŸå ç”¨8000ç«¯å£çš„è¿›ç¨‹

# æ‰‹åŠ¨å¯åŠ¨åº”ç”¨ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰
cd /opt/cosmetic_formula_system
sudo -u www-data bash -c "source venv/bin/activate && python main.py"
```

### 2. æ•°æ®åº“è¿æ¥é—®é¢˜

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u cosmetic_user -p cosmetic_formula_db              # æµ‹è¯•åº”ç”¨æ•°æ®åº“è¿æ¥
mysqladmin -u root -p ping                                 # æµ‹è¯•MySQLæœåŠ¡

# æ£€æŸ¥æ•°æ®åº“é…ç½®
cat /opt/cosmetic_formula_system/mysql_config.ini          # æ£€æŸ¥é…ç½®æ–‡ä»¶

# é‡ç½®æ•°æ®åº“è¿æ¥
sudo systemctl restart mysql                               # é‡å¯MySQLæœåŠ¡
sudo systemctl restart cosmetic-formula                    # é‡å¯åº”ç”¨æœåŠ¡
```

### 3. ç½‘é¡µæ— æ³•è®¿é—®

```bash
# æ£€æŸ¥NginxçŠ¶æ€
sudo systemctl status nginx                                # NginxæœåŠ¡çŠ¶æ€
sudo nginx -t                                              # é…ç½®æ–‡ä»¶è¯­æ³•æ£€æŸ¥

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep :80                             # æ£€æŸ¥80ç«¯å£

# æµ‹è¯•æœ¬åœ°è¿æ¥
curl -I http://localhost                                   # æµ‹è¯•æœ¬åœ°HTTPè¿æ¥
curl -I http://127.0.0.1:8000                            # æµ‹è¯•Pythonåº”ç”¨è¿æ¥

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status                                            # æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
sudo ufw allow 80                                         # å¼€æ”¾80ç«¯å£ï¼ˆå¦‚éœ€è¦ï¼‰
```

### 4. é«˜CPU/å†…å­˜ä½¿ç”¨

```bash
# æŸ¥æ‰¾é«˜èµ„æºä½¿ç”¨è¿›ç¨‹
top -o %CPU                                                # æŒ‰CPUä½¿ç”¨ç‡æ’åº
top -o %MEM                                                # æŒ‰å†…å­˜ä½¿ç”¨ç‡æ’åº

# æ£€æŸ¥Pythonè¿›ç¨‹
ps aux | grep python | grep -v grep                       # æŸ¥çœ‹Pythonè¿›ç¨‹
pgrep -f "python.*main.py" | xargs ps -p                 # æŸ¥çœ‹åº”ç”¨è¿›ç¨‹è¯¦æƒ…

# é‡å¯æœåŠ¡é‡Šæ”¾èµ„æº
sudo systemctl restart cosmetic-formula                    # é‡å¯åº”ç”¨æœåŠ¡
```

---

## ğŸ”’ å®‰å…¨ç»´æŠ¤

### 1. æ–‡ä»¶æƒé™æ£€æŸ¥

```bash
# æ£€æŸ¥é¡¹ç›®ç›®å½•æƒé™
ls -la /opt/cosmetic_formula_system                       # æŸ¥çœ‹æ ¹ç›®å½•æƒé™
ls -la /opt/cosmetic_formula_system/src/                  # æŸ¥çœ‹æºç æƒé™
ls -la /opt/cosmetic_formula_system/*.ini                 # æŸ¥çœ‹é…ç½®æ–‡ä»¶æƒé™

# ä¿®å¤æ–‡ä»¶æƒé™
sudo chown -R www-data:www-data /opt/cosmetic_formula_system  # è®¾ç½®æ‰€æœ‰è€…
sudo chmod -R 755 /opt/cosmetic_formula_system             # è®¾ç½®ç›®å½•æƒé™
sudo chmod 644 /opt/cosmetic_formula_system/*.ini          # è®¾ç½®é…ç½®æ–‡ä»¶æƒé™
```

### 2. ç³»ç»Ÿæ›´æ–°

```bash
# æ›´æ–°ç³»ç»ŸåŒ…
sudo apt update                                            # æ›´æ–°åŒ…åˆ—è¡¨
sudo apt upgrade -y                                        # å‡çº§ç³»ç»ŸåŒ…
sudo apt autoremove -y                                     # æ¸…ç†ä¸éœ€è¦çš„åŒ…

# æ›´æ–°Pythonä¾èµ–
cd /opt/cosmetic_formula_system
sudo -u www-data bash -c "source venv/bin/activate && pip list --outdated"  # æŸ¥çœ‹è¿‡æœŸåŒ…
sudo -u www-data bash -c "source venv/bin/activate && pip install --upgrade pip"  # å‡çº§pip
```

### 3. å®‰å…¨å®¡è®¡

```bash
# æ£€æŸ¥ç™»å½•è®°å½•
last                                                       # æŸ¥çœ‹ç™»å½•è®°å½•
lastlog                                                    # æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·æœ€åç™»å½•æ—¶é—´

# æ£€æŸ¥ç³»ç»ŸæœåŠ¡
sudo systemctl list-units --type=service --state=running  # æŸ¥çœ‹è¿è¡Œä¸­çš„æœåŠ¡
sudo netstat -tlnp                                        # æŸ¥çœ‹æ‰€æœ‰ç›‘å¬ç«¯å£

# æ£€æŸ¥ç”¨æˆ·å’Œæƒé™
cat /etc/passwd | grep -E 'www-data|mysql'                # æŸ¥çœ‹ç³»ç»Ÿç”¨æˆ·
sudo cat /etc/shadow | grep -E 'www-data|mysql'           # æŸ¥çœ‹ç”¨æˆ·å¯†ç çŠ¶æ€
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. ç³»ç»Ÿæ€§èƒ½è°ƒä¼˜

```bash
# è°ƒæ•´æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
echo "* soft nofile 65535" | sudo tee -a /etc/security/limits.conf
echo "* hard nofile 65535" | sudo tee -a /etc/security/limits.conf

# è°ƒæ•´ç½‘ç»œå‚æ•°
echo "net.core.somaxconn = 65535" | sudo tee -a /etc/sysctl.conf
echo "net.core.netdev_max_backlog = 5000" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p                                            # åº”ç”¨ç½‘ç»œå‚æ•°
```

### 2. åº”ç”¨æ€§èƒ½ç›‘æ§

```bash
# ç›‘æ§åº”ç”¨å“åº”æ—¶é—´
time curl -s http://localhost > /dev/null                 # æµ‹è¯•å“åº”æ—¶é—´

# ç›‘æ§å†…å­˜ä½¿ç”¨
ps -o pid,ppid,%mem,%cpu,cmd -p $(pgrep -f "python.*main.py")  # æŸ¥çœ‹åº”ç”¨å†…å­˜ä½¿ç”¨

# ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
sudo -u www-data bash -c "cd /opt/cosmetic_formula_system && source venv/bin/activate && python -c 'import psutil; print(f\"CPU: {psutil.cpu_percent()}%, Memory: {psutil.virtual_memory().percent}%\")'"
```

---

## ğŸš¨ ç´§æ€¥å¤„ç†

### 1. æœåŠ¡å®Œå…¨å´©æºƒ

```bash
#!/bin/bash
echo "ğŸš¨ æ‰§è¡Œç´§æ€¥æ¢å¤ç¨‹åº..."

# åœæ­¢æ‰€æœ‰æœåŠ¡
sudo systemctl stop cosmetic-formula nginx

# æ¸…ç†å¯èƒ½çš„ç«¯å£å ç”¨
sudo fuser -k 8000/tcp
sudo fuser -k 80/tcp

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# é‡å¯æœåŠ¡
sudo systemctl start mysql
sleep 5
sudo systemctl start cosmetic-formula
sleep 10
sudo systemctl start nginx

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status cosmetic-formula nginx mysql --no-pager

echo "âœ… ç´§æ€¥æ¢å¤å®Œæˆ"
```

### 2. æ•°æ®åº“é”å®š/æŸå

```bash
# æ£€æŸ¥MySQLè¿›ç¨‹
sudo mysqladmin -u root -p processlist

# æ€æ­»é˜»å¡çš„MySQLè¿æ¥
# mysql -u root -p -e "KILL CONNECTION_ID;"

# é‡å¯MySQLæœåŠ¡
sudo systemctl restart mysql

# æ£€æŸ¥è¡¨æŸå
mysql -u root -p cosmetic_formula_db -e "CHECK TABLE formulas, formula_ingredients;"

# ä¿®å¤æŸåçš„è¡¨ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰
mysql -u root -p cosmetic_formula_db -e "REPAIR TABLE formulas, formula_ingredients;"
```

---

## ğŸ“‹ æ—¥å¸¸ç»´æŠ¤æ£€æŸ¥æ¸…å•

### æ¯æ—¥æ£€æŸ¥
- [ ] æ£€æŸ¥æœåŠ¡çŠ¶æ€: `sudo systemctl status cosmetic-formula nginx mysql`
- [ ] æŸ¥çœ‹é”™è¯¯æ—¥å¿—: `sudo journalctl -u cosmetic-formula | grep -i error | tail -10`
- [ ] æ£€æŸ¥ç£ç›˜ä½¿ç”¨: `df -h`
- [ ] æ£€æŸ¥å†…å­˜ä½¿ç”¨: `free -h`

### æ¯å‘¨æ£€æŸ¥
- [ ] æ¸…ç†æ—¥å¿—æ–‡ä»¶: `sudo journalctl --vacuum-time=7d`
- [ ] å¤‡ä»½æ•°æ®åº“: `mysqldump -u root -p cosmetic_formula_db > backup_$(date +%Y%m%d).sql`
- [ ] æ£€æŸ¥ç³»ç»Ÿæ›´æ–°: `sudo apt list --upgradable`
- [ ] é‡å¯æœåŠ¡: `sudo systemctl restart cosmetic-formula`

### æ¯æœˆæ£€æŸ¥
- [ ] ç³»ç»Ÿå…¨é¢æ›´æ–°: `sudo apt update && sudo apt upgrade -y`
- [ ] æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶
- [ ] æ£€æŸ¥å®‰å…¨æ—¥å¿—: `last | head -20`
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] é…ç½®æ–‡ä»¶å¤‡ä»½

---

**ç»´æŠ¤æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: $(date +"%Y-%m-%d %H:%M:%S")  
**é€‚ç”¨ç³»ç»Ÿ**: Ubuntu 24.04 LTS  
**ç»´æŠ¤è€…**: ç³»ç»Ÿç®¡ç†å‘˜
