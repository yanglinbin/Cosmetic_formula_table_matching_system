# 化妆品配方匹配系统 - 服务器维护指令大全

## 📋 系统概览

- **系统名称**: 化妆品配方表匹配系统
- **部署路径**: `/opt/cosmetic_formula_system`
- **服务名称**: `cosmetic-formula`
- **端口**: 8000 (内部), 80 (外部)
- **数据库**: MySQL (端口3306)
- **Web服务器**: Nginx (端口80)

---

## 🚀 核心服务管理

### 1. 服务状态检查

```bash
# 检查主要服务状态
sudo systemctl status cosmetic-formula    # Python应用服务
sudo systemctl status nginx               # Web服务器
sudo systemctl status mysql              # 数据库服务

# 一键检查所有服务状态
sudo systemctl status cosmetic-formula nginx mysql --no-pager
```

### 2. 服务启动/停止/重启

```bash
# === Python应用服务 ===
sudo systemctl start cosmetic-formula     # 启动应用服务
sudo systemctl stop cosmetic-formula      # 停止应用服务
sudo systemctl restart cosmetic-formula   # 重启应用服务
sudo systemctl reload cosmetic-formula    # 重新加载配置

# === Nginx Web服务器 ===
sudo systemctl start nginx                # 启动Nginx
sudo systemctl stop nginx                 # 停止Nginx
sudo systemctl restart nginx              # 重启Nginx
sudo systemctl reload nginx               # 重新加载Nginx配置
sudo nginx -s reload                      # 快速重载Nginx配置

# === MySQL数据库 ===
sudo systemctl start mysql                # 启动MySQL
sudo systemctl stop mysql                 # 停止MySQL
sudo systemctl restart mysql              # 重启MySQL

# === 一键重启所有服务 ===
sudo systemctl restart mysql && \
sudo systemctl restart cosmetic-formula && \
sudo systemctl restart nginx && \
echo "✅ 所有服务重启完成"
```

### 3. 开机自启管理

```bash
# 检查服务是否设置为开机自启
sudo systemctl is-enabled cosmetic-formula nginx mysql

# 启用开机自启
sudo systemctl enable cosmetic-formula    # 设置应用服务开机自启
sudo systemctl enable nginx              # 设置Nginx开机自启
sudo systemctl enable mysql              # 设置MySQL开机自启

# 禁用开机自启
sudo systemctl disable cosmetic-formula   # 禁用应用服务开机自启
sudo systemctl disable nginx             # 禁用Nginx开机自启
sudo systemctl disable mysql             # 禁用MySQL开机自启
```

---

## 📊 监控和诊断

### 1. 端口和连接监控

```bash
# 检查端口监听状态
sudo netstat -tlnp | grep -E ':80|:8000|:3306'    # 检查关键端口
sudo ss -tlnp | grep -E ':80|:8000|:3306'         # 现代版本的端口检查

# 检查具体端口占用
sudo lsof -i:8000    # 检查8000端口（Python应用）
sudo lsof -i:80      # 检查80端口（Nginx）
sudo lsof -i:3306    # 检查3306端口（MySQL）

# 检查网络连接数
sudo netstat -ant | grep :80 | wc -l              # 统计80端口连接数
sudo netstat -ant | grep :8000 | wc -l            # 统计8000端口连接数
```

### 2. 进程监控

```bash
# 查看相关进程
ps aux | grep -E 'python|nginx|mysql'             # 查看主要进程
ps aux | grep cosmetic                             # 查看应用相关进程

# 查看进程树
pstree -p | grep -E 'python|nginx|mysql'

# 查看资源使用情况
top -p $(pgrep -d',' -f 'python.*main.py')        # 监控Python应用资源使用
htop                                               # 实时系统监控（如果已安装）
```

### 3. 系统资源监控

```bash
# 内存使用情况
free -h                                            # 查看内存使用情况
free -h -s 5                                       # 每5秒更新一次内存使用情况

# 磁盘使用情况
df -h                                              # 查看磁盘使用情况
du -sh /opt/cosmetic_formula_system                # 查看项目目录大小
du -sh /var/log/                                   # 查看日志目录大小

# CPU使用情况
uptime                                             # 系统负载
iostat -x 1                                        # I/O统计（如果已安装sysstat）
```

---

## 📝 日志管理

### 1. 应用日志查看

```bash
# === 实时日志监控 ===
sudo journalctl -u cosmetic-formula -f            # 实时查看应用日志
sudo journalctl -u nginx -f                       # 实时查看Nginx日志
sudo journalctl -u mysql -f                       # 实时查看MySQL日志

# === 历史日志查看 ===
sudo journalctl -u cosmetic-formula -n 50         # 查看最近50行应用日志
sudo journalctl -u cosmetic-formula --since "1 hour ago"  # 查看最近1小时的日志
sudo journalctl -u cosmetic-formula --since "2023-09-08 00:00:00"  # 查看指定时间后的日志

# === 错误日志筛选 ===
sudo journalctl -u cosmetic-formula | grep -i error       # 筛选错误信息
sudo journalctl -u cosmetic-formula | grep -i "500"       # 筛选HTTP 500错误
sudo journalctl -u cosmetic-formula | grep -i "exception" # 筛选异常信息
```

### 2. Nginx日志管理

```bash
# 查看Nginx访问日志
sudo tail -f /var/log/nginx/access.log             # 实时查看访问日志
sudo tail -n 100 /var/log/nginx/access.log         # 查看最近100行访问日志

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log              # 实时查看错误日志
sudo tail -n 50 /var/log/nginx/error.log           # 查看最近50行错误日志

# 统计访问情况
sudo cat /var/log/nginx/access.log | grep -c "200"        # 统计成功请求数
sudo cat /var/log/nginx/access.log | grep -c "500"        # 统计服务器错误数
sudo cat /var/log/nginx/access.log | awk '{print $1}' | sort | uniq -c | sort -nr | head -10  # 统计访问IP
```

### 3. 日志清理和维护

```bash
# 清理journald日志（保留最近7天）
sudo journalctl --vacuum-time=7d

# 清理journald日志（限制大小为100MB）
sudo journalctl --vacuum-size=100M

# 清理Nginx日志（备份后清理）
sudo cp /var/log/nginx/access.log /var/log/nginx/access.log.backup.$(date +%Y%m%d)
sudo echo "" > /var/log/nginx/access.log
sudo cp /var/log/nginx/error.log /var/log/nginx/error.log.backup.$(date +%Y%m%d)
sudo echo "" > /var/log/nginx/error.log

# 重启rsyslog服务（重新打开日志文件）
sudo systemctl restart rsyslog
```

---

## 🔧 配置文件管理

### 1. 应用配置文件

```bash
# 查看应用配置
cat /opt/cosmetic_formula_system/system_config.ini         # 系统配置
cat /opt/cosmetic_formula_system/mysql_config.ini          # 数据库配置

# 编辑配置文件
sudo nano /opt/cosmetic_formula_system/system_config.ini   # 编辑系统配置
sudo nano /opt/cosmetic_formula_system/mysql_config.ini    # 编辑数据库配置

# 备份配置文件
sudo cp /opt/cosmetic_formula_system/system_config.ini \
    /opt/cosmetic_formula_system/system_config.ini.backup.$(date +%Y%m%d_%H%M%S)
sudo cp /opt/cosmetic_formula_system/mysql_config.ini \
    /opt/cosmetic_formula_system/mysql_config.ini.backup.$(date +%Y%m%d_%H%M%S)
```

### 2. Nginx配置管理

```bash
# 查看Nginx配置
sudo cat /etc/nginx/sites-available/cosmetic-formula       # 查看站点配置
sudo nginx -t                                              # 测试Nginx配置语法

# 编辑Nginx配置
sudo nano /etc/nginx/sites-available/cosmetic-formula      # 编辑站点配置

# 重新加载Nginx配置
sudo nginx -s reload                                        # 重载配置（推荐）
sudo systemctl reload nginx                                # 重载配置
```

### 3. 系统服务配置

```bash
# 查看应用服务配置
sudo cat /etc/systemd/system/cosmetic-formula.service      # 查看服务配置

# 编辑服务配置
sudo nano /etc/systemd/system/cosmetic-formula.service     # 编辑服务配置

# 重新加载系统服务配置
sudo systemctl daemon-reload                               # 重载systemd配置
sudo systemctl restart cosmetic-formula                    # 重启服务使配置生效
```

---

## 💾 数据库维护

### 1. MySQL连接和状态检查

```bash
# 连接MySQL数据库
mysql -u root -p                                           # 管理员连接
mysql -u cosmetic_user -p cosmetic_formula_db             # 应用用户连接

# 检查MySQL状态
sudo systemctl status mysql                                # 服务状态
mysqladmin -u root -p status                              # MySQL服务状态
mysqladmin -u root -p processlist                         # 当前连接列表
```

### 2. 数据库备份

```bash
# 创建备份目录
sudo mkdir -p /opt/backups/cosmetic_formula_db

# 完整数据库备份
sudo mysqldump -u root -p cosmetic_formula_db > /opt/backups/cosmetic_formula_db/backup_$(date +%Y%m%d_%H%M%S).sql

# 备份指定表
sudo mysqldump -u root -p cosmetic_formula_db formulas formula_ingredients > /opt/backups/cosmetic_formula_db/formulas_backup_$(date +%Y%m%d_%H%M%S).sql

# 自动备份脚本（添加到crontab）
# 0 2 * * * /usr/bin/mysqldump -u root -pYOUR_PASSWORD cosmetic_formula_db > /opt/backups/cosmetic_formula_db/auto_backup_$(date +\%Y\%m\%d).sql
```

### 3. 数据库恢复

```bash
# 恢复完整数据库
mysql -u root -p cosmetic_formula_db < /opt/backups/cosmetic_formula_db/backup_20230908_120000.sql

# 恢复指定表
mysql -u root -p cosmetic_formula_db < /opt/backups/cosmetic_formula_db/formulas_backup_20230908_120000.sql
```

### 4. 数据库性能优化

```bash
# 检查数据库大小
mysql -u root -p -e "SELECT table_schema 'Database', ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) 'Size (MB)' FROM information_schema.tables WHERE table_schema='cosmetic_formula_db' GROUP BY table_schema;"

# 优化表
mysql -u root -p cosmetic_formula_db -e "OPTIMIZE TABLE formulas, formula_ingredients;"

# 检查表状态
mysql -u root -p cosmetic_formula_db -e "SHOW TABLE STATUS;"
```

---

## 🛠️ 故障排查

### 1. 应用无法启动

```bash
# 检查服务状态和错误信息
sudo systemctl status cosmetic-formula -l                  # 查看详细状态信息
sudo journalctl -u cosmetic-formula -n 100                # 查看最近100行日志

# 检查端口占用
sudo lsof -i:8000                                          # 检查8000端口占用
sudo fuser -k 8000/tcp                                     # 强制结束占用8000端口的进程

# 手动启动应用（调试模式）
cd /opt/cosmetic_formula_system
sudo -u www-data bash -c "source venv/bin/activate && python main.py"
```

### 2. 数据库连接问题

```bash
# 测试数据库连接
mysql -u cosmetic_user -p cosmetic_formula_db              # 测试应用数据库连接
mysqladmin -u root -p ping                                 # 测试MySQL服务

# 检查数据库配置
cat /opt/cosmetic_formula_system/mysql_config.ini          # 检查配置文件

# 重置数据库连接
sudo systemctl restart mysql                               # 重启MySQL服务
sudo systemctl restart cosmetic-formula                    # 重启应用服务
```

### 3. 网页无法访问

```bash
# 检查Nginx状态
sudo systemctl status nginx                                # Nginx服务状态
sudo nginx -t                                              # 配置文件语法检查

# 检查端口监听
sudo netstat -tlnp | grep :80                             # 检查80端口

# 测试本地连接
curl -I http://localhost                                   # 测试本地HTTP连接
curl -I http://127.0.0.1:8000                            # 测试Python应用连接

# 检查防火墙
sudo ufw status                                            # 查看防火墙状态
sudo ufw allow 80                                         # 开放80端口（如需要）
```

### 4. 高CPU/内存使用

```bash
# 查找高资源使用进程
top -o %CPU                                                # 按CPU使用率排序
top -o %MEM                                                # 按内存使用率排序

# 检查Python进程
ps aux | grep python | grep -v grep                       # 查看Python进程
pgrep -f "python.*main.py" | xargs ps -p                 # 查看应用进程详情

# 重启服务释放资源
sudo systemctl restart cosmetic-formula                    # 重启应用服务
```

---

## 🔒 安全维护

### 1. 文件权限检查

```bash
# 检查项目目录权限
ls -la /opt/cosmetic_formula_system                       # 查看根目录权限
ls -la /opt/cosmetic_formula_system/src/                  # 查看源码权限
ls -la /opt/cosmetic_formula_system/*.ini                 # 查看配置文件权限

# 修复文件权限
sudo chown -R www-data:www-data /opt/cosmetic_formula_system  # 设置所有者
sudo chmod -R 755 /opt/cosmetic_formula_system             # 设置目录权限
sudo chmod 644 /opt/cosmetic_formula_system/*.ini          # 设置配置文件权限
```

### 2. 系统更新

```bash
# 更新系统包
sudo apt update                                            # 更新包列表
sudo apt upgrade -y                                        # 升级系统包
sudo apt autoremove -y                                     # 清理不需要的包

# 更新Python依赖
cd /opt/cosmetic_formula_system
sudo -u www-data bash -c "source venv/bin/activate && pip list --outdated"  # 查看过期包
sudo -u www-data bash -c "source venv/bin/activate && pip install --upgrade pip"  # 升级pip
```

### 3. 安全审计

```bash
# 检查登录记录
last                                                       # 查看登录记录
lastlog                                                    # 查看所有用户最后登录时间

# 检查系统服务
sudo systemctl list-units --type=service --state=running  # 查看运行中的服务
sudo netstat -tlnp                                        # 查看所有监听端口

# 检查用户和权限
cat /etc/passwd | grep -E 'www-data|mysql'                # 查看系统用户
sudo cat /etc/shadow | grep -E 'www-data|mysql'           # 查看用户密码状态
```

---

## 📊 性能优化

### 1. 系统性能调优

```bash
# 调整文件描述符限制
echo "* soft nofile 65535" | sudo tee -a /etc/security/limits.conf
echo "* hard nofile 65535" | sudo tee -a /etc/security/limits.conf

# 调整网络参数
echo "net.core.somaxconn = 65535" | sudo tee -a /etc/sysctl.conf
echo "net.core.netdev_max_backlog = 5000" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p                                            # 应用网络参数
```

### 2. 应用性能监控

```bash
# 监控应用响应时间
time curl -s http://localhost > /dev/null                 # 测试响应时间

# 监控内存使用
ps -o pid,ppid,%mem,%cpu,cmd -p $(pgrep -f "python.*main.py")  # 查看应用内存使用

# 生成性能报告
sudo -u www-data bash -c "cd /opt/cosmetic_formula_system && source venv/bin/activate && python -c 'import psutil; print(f\"CPU: {psutil.cpu_percent()}%, Memory: {psutil.virtual_memory().percent}%\")'"
```

---

## 🚨 紧急处理

### 1. 服务完全崩溃

```bash
#!/bin/bash
echo "🚨 执行紧急恢复程序..."

# 停止所有服务
sudo systemctl stop cosmetic-formula nginx

# 清理可能的端口占用
sudo fuser -k 8000/tcp
sudo fuser -k 80/tcp

# 检查磁盘空间
df -h

# 重启服务
sudo systemctl start mysql
sleep 5
sudo systemctl start cosmetic-formula
sleep 10
sudo systemctl start nginx

# 检查状态
sudo systemctl status cosmetic-formula nginx mysql --no-pager

echo "✅ 紧急恢复完成"
```

### 2. 数据库锁定/损坏

```bash
# 检查MySQL进程
sudo mysqladmin -u root -p processlist

# 杀死阻塞的MySQL连接
# mysql -u root -p -e "KILL CONNECTION_ID;"

# 重启MySQL服务
sudo systemctl restart mysql

# 检查表损坏
mysql -u root -p cosmetic_formula_db -e "CHECK TABLE formulas, formula_ingredients;"

# 修复损坏的表（如有必要）
mysql -u root -p cosmetic_formula_db -e "REPAIR TABLE formulas, formula_ingredients;"
```

---

## 📋 日常维护检查清单

### 每日检查
- [ ] 检查服务状态: `sudo systemctl status cosmetic-formula nginx mysql`
- [ ] 查看错误日志: `sudo journalctl -u cosmetic-formula | grep -i error | tail -10`
- [ ] 检查磁盘使用: `df -h`
- [ ] 检查内存使用: `free -h`

### 每周检查
- [ ] 清理日志文件: `sudo journalctl --vacuum-time=7d`
- [ ] 备份数据库: `mysqldump -u root -p cosmetic_formula_db > backup_$(date +%Y%m%d).sql`
- [ ] 检查系统更新: `sudo apt list --upgradable`
- [ ] 重启服务: `sudo systemctl restart cosmetic-formula`

### 每月检查
- [ ] 系统全面更新: `sudo apt update && sudo apt upgrade -y`
- [ ] 清理旧备份文件
- [ ] 检查安全日志: `last | head -20`
- [ ] 性能基准测试
- [ ] 配置文件备份

---

**维护文档版本**: v1.0  
**最后更新**: $(date +"%Y-%m-%d %H:%M:%S")  
**适用系统**: Ubuntu 24.04 LTS  
**维护者**: 系统管理员
